# v0.9 Apple风格交互式Quiz系统

**实现日期**: 2026-02-19

## 功能概述

完全重构了Quiz系统，从批量提交多类型题目改为Apple风格的即时反馈单选题系统，包含庆祝动画、可折叠布局和完整的CMS编辑支持。

## 核心功能

### 1. 数据结构重构

**位置**: `material.json` 和 `docs/material.json` (705-708行)

全新的Quiz数据结构，支持：
- `title`: Quiz标题
- `description`: Quiz描述
- `collapsed`: 默认折叠状态 (true/false)
- `collapsedLabel`: 折叠条显示文字
- `questions`: 问题数组
  - `question`: 问题文本
  - `options`: 4个选项数组
  - `answer`: 正确答案索引 (0-3)
  - `explanation`: 答案解释

**示例数据**:
```json
{
  "title": "Test Your Knowledge",
  "description": "See how much you've learned about nuclear energy.",
  "collapsed": true,
  "collapsedLabel": "Quick Quiz - 4 Questions",
  "questions": [
    {
      "question": "What particle initiates nuclear fission in a reactor?",
      "options": ["Proton", "Neutron", "Electron", "Photon"],
      "answer": 1,
      "explanation": "A neutron strikes the nucleus..."
    }
  ]
}
```

### 2. 模板系统 (`js/templates.js`)

**完全重写 `quizTemplate()` 函数** (1388-1489行)

**新增功能**:

#### a) 可折叠布局
- **折叠条**: 紧凑的圆角条状设计，带图标和标签
  - 点击展开完整Quiz内容
  - Hover效果: 边框颜色变化 + 背景亮度提升
  - Chevron图标旋转动画

- **展开内容**: 完整的Quiz界面
  - 标题、描述、关闭按钮
  - 进度条显示答题进度
  - 所有问题卡片
  - 完成后的成绩总结

#### b) Apple风格问题卡片
- 大标题 + 编号 (Accent Cyan颜色)
- 选项按钮布局: 2x2网格 (移动端1列)
- 每个选项:
  - 圆角矩形 (24px)
  - 半透明背景 + Glassmorphism效果
  - Hover状态: 边框高亮 + 背景亮度提升
  - 内置Checkmark SVG图标
  - 粒子效果容器

#### c) data-material属性
所有可编辑内容都有 `data-material` 属性：
- `Quiz.title` - 标题
- `Quiz.description` - 描述
- `Quiz.collapsedLabel` - 折叠标签
- `Quiz.questions.0.question` - 第1题题目
- `Quiz.questions.0.options.0` - 第1题第1个选项
- `Quiz.questions.0.explanation` - 第1题解释

### 3. Quiz引擎重写 (`js/quiz.js`)

**完全重写为即时反馈系统** (296行 → 365行)

#### a) 核心功能

**初始化**:
- `init(quizId)`: 初始化单个Quiz
- `initAll()`: 初始化页面所有Quiz
- `attachEventListeners()`: 为所有选项按钮添加点击事件

**答题交互**:
- `handleOptionClick()`: 处理选项点击
  - 检查是否已答题 (防止重复点击)
  - 记录答案
  - 判断对错
  - 显示反馈
  - 显示解释
  - 禁用该题所有选项
  - 更新进度
  - 检查是否完成所有题目

#### b) 正确答案反馈 (`showCorrectFeedback`)

**视觉效果**:
1. **边框和背景**: 绿色边框 + 半透明绿色背景
2. **Checkmark动画**: 
   - SVG路径描边动画 (stroke-dashoffset)
   - 0.6s ease-out
3. **粒子爆发** (`celebrateCorrectAnswer`):
   - 创建12个粒子
   - 径向扩散 (360度均匀分布)
   - 渐变色 (Cyan → 透明)
   - 1s动画后自动清理
4. **弹跳动画**: scale(1.05) → scale(0.98) → scale(1.02) → scale(1.0)

#### c) 错误答案反馈 (`showWrongFeedback`)

**视觉效果**:
1. **选中选项**: 红色边框 + 半透明红色背景
2. **抖动动画**: translateX(-4px ↔ 4px)，5次循环，0.5s
3. **显示正确答案**: 
   - 延迟300ms后高亮正确选项
   - 绿色边框 + Checkmark图标

#### d) 解释面板 (`showExplanation`)

**特性**:
- 延迟400ms后滑入 (避免与反馈动画冲突)
- 带灯泡图标
- 半透明背景 + 边框
- 从上滑入动画 (translateY(-12px) → 0)

#### e) 进度管理

**进度条**:
- 显示 "已答题/总题数"
- 百分比填充动画 (宽度transition)
- Cyan颜色填充

**完成总结** (`showScoreSummary`):
- 延迟800ms显示
- 大Trophy图标
- 显示得分
- "Try Again"按钮
- 渐变背景 (Cyan → Blue)

#### f) 折叠/展开 (`toggleCollapse`)

**功能**:
- 切换 `.quiz-collapsed` / `.quiz-expanded` 类
- Chevron图标旋转180度
- 折叠时滚动到Quiz中心位置

#### g) 重置功能 (`reset`)

**重置内容**:
- 清空所有答案记录
- 隐藏成绩总结
- 重置所有选项样式
- 重置进度条
- 滚动到Quiz顶部

### 4. CSS动画 (`css/input.css`)

**新增135行Quiz专用样式** (750行后)

#### a) 折叠/展开状态
```css
.quiz-section.quiz-collapsed .quiz-collapsed-strip { display: block; }
.quiz-section.quiz-collapsed .quiz-expanded-content { display: none; }
.quiz-section.quiz-expanded .quiz-collapsed-strip { display: none; }
.quiz-section.quiz-expanded .quiz-expanded-content { display: block; }
```

#### b) 核心动画关键帧

**@keyframes quiz-bounce**: 正确答案弹跳
- 0%, 100%: scale(1)
- 25%: scale(1.05)
- 50%: scale(0.98)
- 75%: scale(1.02)

**@keyframes quiz-shake**: 错误答案抖动
- 水平震动 ±4px
- 5次循环

**@keyframes quiz-slide-down**: 面板滑入
- opacity: 0 → 1
- translateY: -12px → 0

**@keyframes checkmark-draw**: Checkmark描边动画
- stroke-dashoffset: 100 → 0

**@keyframes particle-burst**: 粒子爆发
- 从中心点径向扩散
- opacity: 1 → 0
- scale: 1 → 0.3
- 使用CSS变量 --tx, --ty 定义每个粒子的目标位置

#### c) 状态样式

**选项按钮状态**:
- `.quiz-option-correct`: 绿色发光 (box-shadow)
- `.quiz-option-wrong`: 红色发光

**其他元素**:
- `.quiz-progress-fill`: 进度条宽度动画
- `.quiz-explanation-icon`: 渐变背景
- `.quiz-chevron`: 旋转动画

#### d) 响应式设计
```css
@media (max-width: 768px) {
  .quiz-options-grid { grid-template-columns: 1fr; }
}
```

### 5. CMS编辑支持 (`js/editor.js`)

**新增Quiz编辑功能** (2538行后插入约200行)

#### a) 编辑控制面板

**显示时机**: 仅在Edit Mode下显示 (`.edit-mode-only`)

**每个问题卡片底部显示**:
1. **正确答案选择器**:
   - 4个按钮对应4个选项
   - 当前正确答案高亮显示 (绿色边框+背景)
   - 点击切换正确答案
   
2. **删除问题按钮**:
   - 红色边框+背景
   - 确认对话框防止误删

**Quiz底部显示**:
- "Add Question"按钮
  - 虚线边框
  - 加号图标
  - Hover效果

#### b) 核心函数

**enableQuizEditing()**:
- 遍历所有Quiz Section
- 为每个Quiz添加编辑控制
- 在refresh()中自动调用

**addQuizEditControls(quizId)**:
- 为每个问题添加答案切换按钮
- 添加删除问题按钮
- 添加"Add Question"按钮
- 动态生成HTML并插入DOM

**setQuizAnswer(quizId, questionIndex, optionIndex)**:
- 更新指定问题的正确答案
- 触发snapshot (Undo/Redo支持)
- 重新渲染UI

**addQuizQuestion(quizId)**:
- 添加新问题到questions数组
- 默认内容: "New question - click to edit"
- 自动focus新问题并选中文本

**deleteQuizQuestion(quizId, questionIndex)**:
- 删除指定问题
- 确认对话框
- 重新渲染

#### c) 公共API导出

在 `EditorModule` return 对象中添加:
```javascript
{
  setQuizAnswer,
  addQuizQuestion,
  deleteQuizQuestion
}
```

使得模板中的 `onclick` 可以调用:
- `onclick="EditorModule.setQuizAnswer('Quiz', 0, 1)"`
- `onclick="EditorModule.addQuizQuestion('Quiz')"`
- `onclick="EditorModule.deleteQuizQuestion('Quiz', 0)"`

### 6. 内联编辑

所有Quiz文本内容通过现有的 `data-material` 系统支持内联编辑：

- **题目**: 直接点击编辑
- **选项**: 直接点击编辑
- **解释**: 直接点击编辑
- **标题/描述**: 直接点击编辑

编辑后自动保存到 material.json (通过 `handleTextEdit` 函数)

## 技术实现细节

### 动画性能优化

1. **CSS Transform优先**: 使用transform而非top/left
2. **will-change提示**: 关键动画元素添加will-change
3. **requestAnimationFrame**: JS动画使用RAF
4. **动画清理**: 粒子动画完成后移除DOM节点

### 事件管理

1. **事件委托**: 选项按钮使用addEventListener而非inline onclick
2. **防重复点击**: 检查 `quiz.answers[questionIndex]` 防止重复作答
3. **自动清理**: reset时移除所有动画状态

### 数据流

```
material.json
    ↓
quizTemplate() 渲染HTML
    ↓
QuizEngine.init() 初始化状态
    ↓
attachEventListeners() 绑定事件
    ↓
用户点击选项
    ↓
handleOptionClick() 处理答案
    ↓
showFeedback() + showExplanation()
    ↓
updateProgress()
    ↓
(所有题答完) showScoreSummary()
```

### 编辑模式数据流

```
用户在Edit Mode点击"Set Answer"按钮
    ↓
EditorModule.setQuizAnswer()
    ↓
更新 material.index.Quiz.questions[i].answer
    ↓
ModeManager.updateMaterialInMemory()
    ↓
SectionRenderer.render()
    ↓
EditorModule.refresh()
    ↓
重新添加编辑控制
```

## 文件修改清单

| 文件 | 修改内容 | 行数变化 |
|------|---------|---------|
| `material.json` | 添加Quiz section到config.sections，添加完整Quiz数据 | +50 |
| `docs/material.json` | 同上 | +50 |
| `js/templates.js` | 完全重写quizTemplate() | +100 |
| `docs/js/templates.js` | 同上 | +100 |
| `js/quiz.js` | 完全重写Quiz引擎 | +365 (重写) |
| `docs/js/quiz.js` | 同上 | +365 (重写) |
| `css/input.css` | 添加Quiz动画和样式 | +135 |
| `js/editor.js` | 添加Quiz编辑功能 | +200 |
| `docs/js/editor.js` | 同上 | +200 |
| `css/styles.css` | 编译后的CSS | 自动生成 |
| `docs/css/styles.css` | 复制编译后的CSS | 自动生成 |

## 使用方式

### 1. 查看Quiz (用户)

1. 页面加载后，Quiz默认显示为折叠的紧凑条状
2. 点击折叠条展开完整Quiz
3. 阅读问题，点击任意选项作答
4. 立即看到对错反馈 + 解释
5. 答完所有题目后查看总分
6. 点击"Try Again"重新开始
7. 点击右上角X或折叠条重新折叠

### 2. 编辑Quiz (CMS模式)

**编辑问题/选项/解释**:
1. 进入Edit Mode (点击铅笔图标)
2. 展开Quiz
3. 直接点击任意文本内容编辑

**设置正确答案**:
1. 在问题底部的"Correct Answer"区域
2. 点击对应的数字按钮 (1-4)
3. 绿色高亮表示当前正确答案

**添加新问题**:
1. 滚动到Quiz底部
2. 点击"Add Question"按钮
3. 编辑新问题的内容

**删除问题**:
1. 点击问题底部的"Delete Question"按钮
2. 确认删除

## 设计亮点

### Apple风格特征

1. **极简美学**:
   - 大圆角 (24px, 32px)
   - 充足留白
   - 渐变色使用克制

2. **流畅动画**:
   - cubic-bezier缓动函数
   - 适当的延迟 (stagger effect)
   - 自然的弹性效果

3. **Glassmorphism**:
   - 半透明背景
   - Backdrop blur
   - 微妙的边框

4. **交互反馈**:
   - Hover状态明显
   - 点击有视觉/触觉反馈
   - 动画过程流畅连贯

5. **渐进式展示**:
   - 默认折叠节省空间
   - 展开后信息层次清晰
   - 进度可视化

### 可访问性

1. **语义化HTML**: section, button等标签
2. **ARIA标签**: aria-label提供上下文
3. **键盘导航**: 按钮可Tab导航
4. **颜色对比**: 文字颜色符合WCAG标准
5. **响应式设计**: 移动端单列布局

## 已知问题和改进空间

### 当前限制

1. **题目类型**: 仅支持4选1单选题
2. **顺序**: 问题按顺序展示，不支持随机
3. **计时**: 无答题计时功能
4. **统计**: 无答题历史记录

### 未来改进方向

1. **题库管理**: 支持多个Quiz，随机抽题
2. **难度分级**: 问题标记难度，自适应出题
3. **成绩保存**: 本地存储或后端API保存成绩
4. **社交功能**: 分享成绩，排行榜
5. **多媒体**: 问题中嵌入图片/视频
6. **题型扩展**: True/False, 多选，填空等

## 测试建议

### 功能测试

1. ✅ 折叠/展开切换是否正常
2. ✅ 点击选项是否正确显示反馈
3. ✅ 正确答案是否显示庆祝动画
4. ✅ 错误答案是否显示正确答案
5. ✅ 解释面板是否正确显示
6. ✅ 进度条是否正确更新
7. ✅ 成绩总结是否正确计算
8. ✅ Reset功能是否完全重置状态
9. ✅ 编辑模式下是否显示控制面板
10. ✅ 答案切换是否正确更新
11. ✅ 添加/删除问题是否正常
12. ✅ 内联编辑是否保存到material.json

### 性能测试

1. ✅ 粒子动画是否流畅 (60fps)
2. ✅ 大量问题时是否卡顿
3. ✅ CSS文件大小是否合理
4. ✅ 首屏加载时间

### 兼容性测试

1. ✅ Chrome/Edge (Chromium)
2. ✅ Firefox
3. ✅ Safari (注意-webkit前缀)
4. ✅ 移动端Safari
5. ✅ 移动端Chrome

### 响应式测试

1. ✅ 桌面端 (>1024px)
2. ✅ 平板 (768-1024px)
3. ✅ 手机 (<768px)
4. ✅ 超大屏 (>1440px)

## 参考资料

- Apple Human Interface Guidelines: [https://developer.apple.com/design/human-interface-guidelines/](https://developer.apple.com/design/human-interface-guidelines/)
- CSS Animations Performance: [https://web.dev/animations/](https://web.dev/animations/)
- Tailwind CSS Documentation: [https://tailwindcss.com/docs](https://tailwindcss.com/docs)

## 总结

本次更新完全重构了Quiz系统，从功能性工具升级为Apple风格的交互体验。通过即时反馈、流畅动画和精致的视觉设计，大幅提升了用户参与度。同时，完整的CMS编辑支持使得内容管理变得简单直观。

Quiz系统现在已成为整个项目中最具交互性和视觉吸引力的组件之一，为教育类网站提供了标准化的知识检测解决方案。

## 增量更新（2026-02-19）- Fission Section 题库替换

根据外部文档 `potential questions for fission section.docx`，已将题目内容同步到第一个 Quiz（`index.Quiz.questions`），并尽量保持原文措辞。

### 本次更新内容

1. 题目数量由 4 题更新为 5 题。
2. `collapsedLabel` 从 `Quick Quiz - 4 Questions` 更新为 `Quick Quiz - 5 Questions`。
3. 题干、选项、正确答案、解释均按文档内容替换，答案索引映射如下：
   - Q1: B -> `answer: 1`
   - Q2: B -> `answer: 1`
   - Q3: B -> `answer: 1`
   - Q4: C -> `answer: 2`
   - Q5: B -> `answer: 1`
4. 为保证"前端编辑界面"和发布内容一致，已双向同步：
   - `docs/material.json`
   - `material.json`

### 说明

- 本次仅替换 Quiz 数据，不改动模板和交互逻辑。
- 题目文本以"尽量不改动"为原则，唯一做的轻微规范化是将文档导出中缺失的公式尾部补为 `E = mc^2`，避免解释句子断裂。

## 增量更新（2026-02-19）- TIL/RIL 详情图像填充与切换丢字修复

本次针对 `text-image-left` / `text-image-right`（即 TIL/RIL）在详情态中的两个问题进行了根因级修复。

### 问题与修复

1. **详情态图片显示为原始比例（未裁切填充）**
   - **现象**：进入 detail 后，图片按原始比例显示，未按容器进行 `cover` 裁切填充。
   - **根因**：material.json 中几乎所有 item 的 `positionDetail` 都存储了 `"scale": 100`（初始默认值）。渲染代码将 `100` 作为有效值传入 `background-size: 100%`，等价于图片宽度等于容器宽度、高度按原比例，而非 `cover`。
   - **修复**：
     - **渲染侧**：将 `scale: 100`（默认值）视为"未设置"，统一回退 `background-size: cover`。仅当用户手动缩放到非 100 的值时才使用百分比。
     - **保存侧**：不再保存默认 `scale: 100`。
     - **数据清理**：清理了 `docs/material.json` 和 `material.json` 中所有 `positionDetail.scale: 100` 条目。

2. **detail 模式切换 section 文字丢失**
   - **现象**：在 detail 展开状态下切换 tab，详情文字消失。
   - **根因**：`switchToIndex` 动画完成后的 cleanup 代码将 `activeContent.style.opacity` 清空为 `''`。而 `detailContent` 的 Tailwind 类自带 `opacity-0 pointer-events-none`，内联样式被清空后 class 接管 → 内容变透明 → 视觉上"丢失"。
   - **修复**：
     - 动画 cleanup 阶段显式设置 `activeContent.style.opacity = '1'` 和 `pointerEvents = 'auto'`，而非清空为空字符串。
   - **额外加固**：`expandDetail()` 改为从实时 material 读取数据（通过 `getNestedValue`），而非从初始化时缓存的 `items[]` JSON 快照。避免了"编辑后退出 detail 再进入时内容回退旧版本"的潜在问题。

### 同步文件

- `docs/js/section-renderer.js` / `js/section-renderer.js`（逻辑修复）
- `docs/material.json` / `material.json`（数据清理）

# v0.8 斜杠命令与媒体插入功能

**实现日期**: 2025-02-15

## 功能概述

为所有 detail 编辑区域添加了 '/' 命令触发机制,支持快速插入图片和视频,并可以通过拖拽调整大小。

## 核心功能

### 1. '/' 命令触发系统 (类似 @ mention)

在所有包含 `data-material` 且 `contenteditable="true"` 的 detail 编辑区域:
- 输入 `/` 字符自动弹出命令菜单
- 支持键盘导航 (↑↓ 箭头键、Enter 确认、Esc 取消)
- 命令菜单包含:
  - **插入图片**: 上传本地图片文件
  - **插入视频**: 上传本地视频文件

**实现位置**: `js/editor.js` (2722行起)
- `setupSlashCommandSystem()`: 初始化斜杠命令系统
- `handleSlashKeyup()`: 处理斜杠键入事件
- `showCommandDropdown()`: 显示命令下拉菜单
- `executeCommand()`: 执行选中的命令

### 2. 媒体上传功能

**上传流程**:
1. 用户选择 "插入图片" 或 "插入视频" 命令
2. 触发浏览器原生文件选择器
3. 文件上传到服务器 `/upload` 端点
4. 返回文件URL
5. 将媒体块插入到 detail 内容末尾

**实现函数**:
- `triggerMediaUpload()`: 触发文件上传
- `uploadMediaFile()`: 执行文件上传请求
- `insertMediaBlock()`: 将上传的媒体插入到 material 数据中

### 3. detailBlocks 数据结构

引入新的富文本块数组结构,取代原有的简单字符串 `detail` 字段:

```javascript
// 旧格式
{
  detail: "这是一段文本内容..."
}

// 新格式
{
  detailBlocks: [
    { type: 'text', content: '这是一段文本内容...' },
    { type: 'image', url: '/uploads/image.jpg', width: 600 },
    { type: 'video', url: '/uploads/video.mp4', width: 800 }
  ]
}
```

**向后兼容**:
- 如果 `detailBlocks` 不存在,渲染时会自动使用旧的 `detail` 字符串
- 首次插入媒体时,会自动将 `detail` 字符串迁移为 `detailBlocks` 数组

### 4. 媒体块渲染

**实现位置**: `js/templates.js`

新增 `renderDetailBlocks()` 函数,支持三种块类型:
- **text块**: 普通文本段落
- **image块**: 图片,居中显示,可调整宽度
- **video块**: 视频,居中显示,可调整宽度,包含播放控件

每个媒体块包含:
- 居中布局容器 (`.detail-media-block`)
- 可调宽度包裹器 (`.detail-media-wrapper`)
- 媒体内容 (图片/视频)
- 拖拽调整把手 (`.detail-media-resize-handle`)
- 删除按钮 (`.detail-media-delete`)

**修改的渲染函数**:
- `renderDetailContent()`: 支持 `detailBlocks` 和 `detailBlocksPath` 参数
- `renderFlipWrapper()`: 传递 `detailBlocks` 到 detail 内容渲染

**更新的模板**:
- `tabbedContentTemplate()` (Highlights)
- `textImageLeftTemplate()` (Safety, Innovation)
- `textImageRightTemplate()` (Economy)
- `accordionTemplate()` (Closer Look)

### 5. 拖拽调整大小功能

**实现位置**: `js/editor.js` (3000行起)

**交互流程**:
1. 鼠标悬停在媒体块上,显示右侧调整把手
2. 拖拽把手左右移动
3. 实时更新媒体块宽度 (限制在 200px - 1200px)
4. 松开鼠标,自动保存新宽度到 material.json

**实现函数**:
- `initMediaResizeHandlers()`: 初始化调整大小监听器
- `handleResizeStart()`: 开始拖拽
- `handleResizeMove()`: 拖拽过程中更新宽度
- `handleResizeEnd()`: 完成拖拽,保存宽度
- `updateMediaBlockWidth()`: 更新 material 中的宽度数据

### 6. 媒体块删除功能

在编辑模式下,媒体块右上角显示删除按钮:
- 点击删除按钮移除对应的 media block
- 自动更新 `detailBlocks` 数组
- 重新渲染 detail 内容

**实现函数**: `handleMediaDelete()`

### 7. CSS 样式

**新增样式** (`css/styles.css`, 2180行起):

```css
/* 命令下拉菜单 */
.command-dropdown
.command-dropdown-item
.command-dropdown-item-icon
.command-dropdown-item-content

/* 媒体块 */
.detail-media-block
.detail-media-wrapper
.detail-media-content
.detail-media-resize-handle
.detail-media-delete

/* 上传指示器 */
.upload-indicator
.upload-spinner
```

## 使用场景

### 适用的 detail 区域

所有包含以下特征的编辑区域都支持 '/' 命令:
- 具有 `data-material` 属性
- 属性值包含 "detail" 路径
- `contenteditable="true"` (编辑模式)

包括但不限于:
- Highlights (tabbed-content) 的每个 tab 的 detail
- Features (card-grid) 的每个卡片的 detail
- Safety, Innovation, Economy (text-image) 的 detail
- Closer Look (accordion) 的每个 feature 的 detail
- Interactive Details 的每个 item 的 detail

### 用户操作流程

1. 进入编辑模式
2. 点击任意 detail 内容区域
3. 输入 `/` 触发命令菜单
4. 选择 "插入图片" 或 "插入视频"
5. 在文件选择器中选择文件
6. 等待上传完成
7. 图片/视频自动插入到 detail 末尾
8. 鼠标悬停在媒体块上,拖拽右侧把手调整宽度
9. 保存修改

## 技术细节

### 数据流

```
用户输入 '/'
  ↓
显示命令菜单
  ↓
选择命令 (image/video)
  ↓
触发文件上传
  ↓
上传到 /upload 端点
  ↓
获取文件 URL
  ↓
更新 material.detailBlocks
  ↓
重新渲染 detail 内容
  ↓
初始化调整大小监听器
```

### 与现有功能的集成

1. **@ 引用系统**: 斜杠命令系统与 @ 引用系统并行工作,互不干扰
2. **编辑模式**: 斜杠命令只在编辑模式 (`edit-mode` class) 下激活
3. **材料保存**: 媒体块数据自动保存到 material.json
4. **离线导出**: 支持导出到本地文件夹

### 初始化时机

在 `enable()` 函数中:
```javascript
setupAtMentionSystem();      // @ 引用系统
setupSlashCommandSystem();   // 斜杠命令系统
setupCitationClickHandlers(); // 引用点击处理
initMediaResizeHandlers();   // 媒体调整大小
```

在 `disable()` 函数中:
```javascript
cleanupAtMentionSystem();
cleanupSlashCommandSystem();
removeCitationClickHandlers();
```

## 已知限制

1. **插入位置**: 目前只能在 detail 文本末尾插入媒体,不能在文本中间插入
2. **编辑文本块**: 插入媒体后,原有 detail 文本会变成 text 块,但暂不支持直接编辑 text 块内容
3. **文件大小**: 未限制上传文件大小,需要服务器端配置
4. **拖拽方向**: 只支持左右拖拽调整宽度,不支持调整高度

## 未来改进方向

1. 支持在光标位置插入媒体 (需要更复杂的富文本编辑器)
2. 支持编辑 text 块内容
3. 支持更多媒体类型 (音频、PDF 等)
4. 支持从 URL 插入媒体
5. 添加图片裁剪和编辑功能
6. 支持拖拽排序媒体块

## 测试建议

1. ✅ 在不同 detail 区域测试 '/' 命令触发
2. ✅ 测试上传不同格式的图片 (jpg, png, gif)
3. ✅ 测试上传不同格式的视频 (mp4, webm)
4. ✅ 测试拖拽调整媒体大小
5. ✅ 测试删除媒体块
6. ✅ 测试保存和重新加载
7. ✅ 测试向后兼容 (旧的 detail 字符串格式)
8. ✅ 测试离线导出功能

## 相关文件

- `js/editor.js`: 斜杠命令系统、媒体上传、调整大小
- `js/templates.js`: detailBlocks 渲染、模板更新
- `css/styles.css`: 命令菜单、媒体块样式
- `server/routes/upload.js`: 文件上传端点 (已有)

## 内容更新：docs/MSR 页面填充（来自 MSR Write Up.docx）

**实现日期**: 2026-02-15

将 `docs` 站点的 MSR（`interactive-details` 模板）从占位内容替换为文档原文，并按 **Section / Key Sentences / Details** 三段式组织内容，尽可能保留原句与段落结构。

- **数据更新位置**: `docs/material.json` 的 `index.MSR`
- **离线回退一致性**: 同步更新 `docs/index.html` 内嵌的 `window.__PRELOADED_MATERIAL__` 对应 `MSR` 块（避免 `file://` 下 fetch 失败时内容不一致）

MSR Items 拆分为：
- Summary for Main Page
- What are MSRs?
- How MSRs work
- Fuel recycling / cleaning
- Alternative fuel sources
- Increased passive safety
- Reduced / less dangerous waste and byproducts
- Challenges surrounding MSRs
- References

### 修正：按文档 1/2/3 Section 收敛为 3 项

根据 `MSR Write Up.docx` 中明确标注的 1/2/3 Section，将 MSR 的 `interactive-details` 左侧目录收敛为 **3 个 items**：
- **1. What are MSRs?**（合并 Summary + 定义 + 分类）
- **2. How MSRs Work**（Similarities/Differences）
- **3. Benefits and challenges**（合并 benefits 各子段 + challenges + references）

实现方式：更新 `docs/material.json` 与 `docs/index.html` 内嵌回退数据中的 `index.MSR.items`，由多条 Topic 合并为 3 条 Section，内容尽量保持原文句子与段落顺序。

## v0.9 Text Image Left 模板增强：FLIP 变形动画与自然尺寸图片

**实现日期**: 2026-02-15

### 功能概述

为 `text-image-left` 模板（目前应用于 `safety` 和 `innovation` sections）添加两项增强功能：
1. **Apple 风格的 FLIP 变形切换动画**：section 切换时，标题以平滑的缩放+位移动画从当前按钮位置变形到目标按钮位置
2. **Detail 视图自然尺寸图片显示**：点击 "Learn more" 后，detail banner 图片按上传原始尺寸显示（不拉伸），通过 `detailImageShrinkRatio` 参数控制最大约束

### 1. FLIP 变形切换动画

**实现位置**: `Example/js/section-renderer.js` - `initializeTextImageLeftSwitchers()` 函数中的 `switchToIndex()`

**动画原理** (First, Last, Invert, Play):
1. **Phase 1 (Shrink out)**: 
   - 捕获当前标题元素的 bounding rect 和当前按钮的 bounding rect
   - 计算缩放比例 (按钮宽高 / 标题宽高) 和位移 delta
   - 应用 CSS transform，将标题缩小并平移到当前按钮位置（~350ms cubic-bezier）
   - 同时淡出描述文本（~250ms）

2. **Phase 2 (Swap content)**:
   - 更新标题和描述的 `textContent`
   - 更新 `data-material` 属性
   - 更新图片源（视频或背景图）
   - 更新按钮激活状态

3. **Phase 3 (Expand in)**:
   - 捕获新按钮的 bounding rect
   - 无过渡地将标题定位在新按钮处（缩小状态）
   - 使用 `requestAnimationFrame` 触发动画，将标题还原到原始尺寸和位置（~350ms cubic-bezier）
   - 同时淡入描述文本（~350ms）

4. **Image cross-fade**: 保持现有的图片淡入淡出动画，与标题变形并行运行

**CSS 支持** (`Example/css/styles.css`):
```css
.til-title {
  transform-origin: left top;
}
.til-description {
  transform-origin: left top;
}
.til-title--morphing,
.til-description--morphing {
  will-change: transform, opacity;
}
```

**效果**: 
- 标题像"液态"一样从一个按钮位置流动到另一个按钮位置
- 描述在切换时优雅地淡入淡出
- 图片在背景平滑交叉淡化
- 整体视觉连续性强，符合 Apple 产品的动画风格

### 2. Detail 视图自然尺寸图片

**需求**: 点击 "Learn more details" 后，右侧 detail banner 图片不再拉伸填充整个容器，而是按照上传时的原始像素尺寸显示，`detailImageShrinkRatio` 参数作为最大宽高约束。

**实现位置**:

#### 模板层 (`Example/js/templates.js`)

修改 `renderDetailMedia()` 函数:
- 新增参数 `useNaturalSize` 和 `shrinkRatio`
- 当 `useNaturalSize` 为 `true` 且 `shrinkRatio` 存在时：
  - 渲染 `<img>` 标签而非 `background-image` div
  - 图片包裹在 `.detail-banner-media--natural` 容器中
  - `<img>` 添加 `.detail-banner-img-natural` 类
  - 通过 CSS 变量 `--detail-banner-shrink-ratio` 控制最大宽度

修改 `renderDetailContent()` 函数:
- 检测 `bannerShrinkRatio` 参数是否存在
- 如果存在，设置 `useNaturalSize = true`
- 将标志传递给 `renderDetailMedia()`

**数据流**:
```
textImageLeftTemplate
  ↓ 为每个 item 设置 detailImageShrinkRatio
  ↓ 构建 detail panels
  ↓ 调用 renderDetailContent({ bannerShrinkRatio })
  ↓ 检测到 shrinkRatio → useNaturalSize = true
  ↓ renderDetailMedia(..., useNaturalSize, shrinkRatio)
  ↓ 渲染 <img class="detail-banner-img-natural">
```

#### 样式层 (`Example/css/styles.css`)

新增样式:
```css
.detail-banner-media--natural {
  height: auto;
  min-height: 0;
  max-height: none;
  display: flex;
  justify-content: center;
  align-items: center;
  background: none;
  border: none;
}

.detail-banner-img-natural {
  display: block;
  max-width: calc(var(--detail-banner-shrink-ratio, 60) * 1%);
  max-height: 50vh;
  height: auto;
  width: auto;
  object-fit: none;  /* 不缩放，保持原始尺寸 */
  border-radius: 12px;
}
```

**效果**:
- 图片以原始上传尺寸显示，不会被拉伸或裁切
- `detailImageShrinkRatio` (默认 60) 控制图片最大占据视口宽度的百分比
- 图片居中显示在 detail banner 区域
- 如果图片小于约束尺寸，按原始尺寸显示；如果超过约束，按比例缩小到约束范围内

### 3. 文件同步

所有修改同步到 `docs/` 目录:
- `docs/css/styles.css` ← `Example/css/styles.css`
- `docs/js/templates.js` ← `Example/js/templates.js`
- `docs/js/section-renderer.js` ← `Example/js/section-renderer.js`

### 技术要点

#### FLIP 动画关键

1. **getBoundingClientRect()**: 获取元素当前在视口中的精确位置
2. **transform 优化**: 使用 `translate` + `scale` 而非 `width`/`height`，由 GPU 加速
3. **will-change 声明**: 提前告知浏览器哪些属性将改变，优化渲染性能
4. **requestAnimationFrame**: 确保在浏览器重绘前应用 transform，避免闪烁
5. **cubic-bezier 缓动**: `cubic-bezier(0.4, 0.0, 0.2, 1)` 产生平滑的加速-减速效果

#### Natural Size 实现关键

1. **条件渲染**: 仅对 TIL 模板使用自然尺寸模式，其他模板保持 `background-image` 填充模式
2. **CSS 变量传递**: `--detail-banner-shrink-ratio` 在 inline style 设置，CSS 通过 `calc()` 使用
3. **object-fit: none**: 关键属性，确保图片不被浏览器自动缩放
4. **向后兼容**: 旧的 card-grid 和 tabbed-content 模板不传 `bannerShrinkRatio`，继续使用 `background-image` 模式

### 用户体验改进

**Before**:
- Section 切换：标题和描述瞬间替换（无动画）
- Detail 图片：拉伸填充整个横幅区域，可能变形

**After**:
- Section 切换：标题如液体般从一个按钮"流动"到另一个按钮，视觉连贯流畅
- Detail 图片：保持原始比例和尺寸，图片质量不受损失，用户可通过 shrink ratio 控制显示大小

### 相关文件

- `Example/js/section-renderer.js` (line 518-680): FLIP 变形动画实现
- `Example/js/templates.js` (line 49-84, 369-399): 自然尺寸图片渲染
- `Example/css/styles.css` (line 3501-3585): 变形动画和自然尺寸图片样式
- `docs/js/`, `docs/css/`: 镜像副本

---

## v1.0 Text Image Left 模板重新设计：去除翻转，同面布局切换

**日期**: 2026-02-15  
**修改类型**: 重新设计核心交互，移除 flip-card 机制

### 背景

用户反馈了两个主要问题：
1. **Section 切换按钮不显示**：当前 safety section 只有单一数据结构（没有 `items` 数组），而之前的实现要求 `items` 数组才能显示切换按钮
2. **Detail 展开效果不符合预期**：用户期望的是同一个面的布局重组（右侧图片缩小移到右边，左侧显示 detail 内容），而不是 flip 翻转到背面

### 核心改动

#### 1. 完全移除 Flip Card 机制

**Before (v0.9)**:
- 使用 `.flip-card` 结构，包含 `.flip-card-front` 和 `.flip-card-back`
- 点击"Learn more"触发 Y 轴 180° 翻转
- Detail 内容在背面显示

**After (v1.0)**:
- 使用 `.til-container` 扁平结构，无 front/back 分层
- 左侧区域包含两个状态层：
  - `.til-collapsed-content`: 标题/描述/CTA 按钮（collapsed 状态显示）
  - `.til-detail-content`: Detail 内容（expanded 状态显示）
- 右侧区域：图片容器，宽度根据状态动态调整
- 状态切换通过 `opacity` 和 `pointer-events` 控制可见性

#### 2. 同面布局切换动画

**Collapsed → Expanded (点击 Learn more)**:
1. 左侧 collapsed content 淡出 (`opacity: 0`)
2. 右侧图片区域宽度缩小到 `shrinkRatio%`（默认 60%）
3. 延迟 300ms 后，左侧 detail content 淡入 (`opacity: 1`)

**Expanded → Collapsed (点击 Close)**:
1. 左侧 detail content 淡出
2. 右侧图片区域宽度恢复到 `calc(100% - 500px - 80px)`
3. 延迟 300ms 后，左侧 collapsed content 淡入

**关键 CSS**:
```css
.til-right-area {
  transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
}

.til-collapsed-content,
.til-detail-content {
  transition: opacity 0.3s ease;
}
```

#### 3. Section 切换保留 FLIP 变形动画

Section 按钮切换的标题变形动画**保持不变**，继续使用 v0.9 实现的 FLIP 技术：
- 标题从当前按钮位置缩小消失
- 内容更新
- 标题从新按钮位置放大出现

这一动画与 detail 展开/收起动画**独立**，可以在任何状态下执行。

#### 4. 支持单 item 和多 item Section

**模板兼容性改进**:
- 检测 `data.items` 是否为数组
- 如果有 `items`，material 路径为 `${sectionId}.items.0.xxx`
- 如果无 `items`（如 safety），material 路径为 `${sectionId}.xxx`
- 切换按钮仅在 `items.length > 1` 时显示

**示例**:
- `safety` section: 单一结构，无切换按钮，支持 detail 展开
- `innovation.items[]`: 多 item 结构，显示切换按钮，每个 item 独立的 detail 内容

### 技术实现

#### templates.js 变更

**关键变量**:
```javascript
const hasItemsArray = Array.isArray(data?.items) && data.items.length > 0;
const materialPrefix = hasItemsArray ? `${sectionId}.items.0` : sectionId;
```

**新模板结构**:
- 移除 `flip-card`, `flip-card-inner`, `flip-card-front/back` 层级
- 使用 `data-til-detail-state="collapsed"` 跟踪展开状态
- 添加 `data-til-has-items` 属性用于调试
- 左右区域采用 `absolute` 定位，便于独立控制尺寸和位置

#### section-renderer.js 变更

**新增函数逻辑**:
1. **expandDetail()**: 展开 detail 视图
   - 淡出 collapsed content
   - 缩小 right area 到 `shrinkRatio%`
   - 淡入 detail content
   - 渲染 LaTeX（如果有）

2. **collapseDetail()**: 收起 detail 视图
   - 淡出 detail content
   - 恢复 right area 宽度
   - 淡入 collapsed content

3. **switchToIndex()**: Section 切换（保留 FLIP 动画）
   - 更新 title, description, imageLabel
   - 更新 detail content (detailTitleEl, detailTextEl)
   - 更新图片或视频
   - 更新按钮 active 状态

**事件监听**:
- `[data-til-learn-more]` → `expandDetail()`
- `[data-til-close]` → `collapseDetail()`
- `.til-switcher-btn` → `switchToIndex(targetIndex)`

#### styles.css 变更

**新增样式**:
```css
/* TIL container layout */
.til-container {
  position: relative;
}

.til-left-area {
  z-index: 2;  /* 确保左侧内容在右侧图片上方 */
}

.til-right-area {
  z-index: 1;
  transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
}

.til-collapsed-content,
.til-detail-content {
  transition: opacity 0.3s ease;
}

.til-image-wrapper {
  transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
}
```

### 用户体验改进

**Before (v0.9)**:
- 点击 Learn more：整个卡片 Y 轴翻转 180°，背面显示 detail
- 视觉割裂感强，front 和 back 是两个独立世界

**After (v1.0)**:
- 点击 Learn more：右侧图片优雅地缩小到一边，左侧内容平滑切换
- 所有元素在同一平面，空间感连贯，类似 Apple 产品页面的布局切换
- Section 切换时，标题仍保留"液体流动"的 FLIP 变形动画

### 文件同步

所有修改同步到 `docs/` 目录:
- `docs/css/styles.css` ← `Example/css/styles.css`
- `docs/js/templates.js` ← `Example/js/templates.js`
- `docs/js/section-renderer.js` ← `Example/js/section-renderer.js`

### 相关文件

- `Example/js/templates.js` (line 833-953): TIL 模板重新设计
- `Example/js/section-renderer.js` (line 518-782): Detail 展开/收起 + Section 切换
- `Example/css/styles.css` (line 3501-3565): TIL 布局切换样式
- `docs/js/`, `docs/css/`: 镜像副本

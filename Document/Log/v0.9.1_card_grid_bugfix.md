# v0.9.1 Card Grid Bug修复

**修复日期**: 2026-02-20

## 修复概述

修复了Card Grid组件的两个关键Bug：Banner图片缩放/位置不持久化以及Reference区块样式缺失。

## 修复的问题

### Bug 1: Card Grid Banner图片缩放/位置修改后刷新丢失

**文件**: `js/section-renderer.js`, `docs/js/section-renderer.js`

**根因**: `initializeImagePositionControls` 在页面加载时会从 `material.json` 中读取已保存的 `detailImagePosition` 数据，并正确设置了滑块的初始值。但它**没有调用 `applyImagePosition`** 将这些值实际应用到 DOM 元素上。

CSS 中 `.detail-banner-media` 的默认样式 `background-size: cover; background-position: center;` 会覆盖任何已保存的位置值。因此，即使数据已正确写入 `material.json`（如 `detailImagePosition: {scale: 50}`），页面刷新后 Banner 图片仍以默认缩放和位置显示。

**修复方式**: 在 `initializeImagePositionControls` 创建控件并设置滑块值之后，立即调用 `applyImagePosition` 将保存的 X/Y/Scale 值应用到元素的 `background-position` 和 `background-size` 样式上。

```javascript
// 创建控件后立即应用已保存的位置值
if (currentX !== 50 || currentY !== 50 || currentScale !== 100) {
  applyImagePosition(imgEl, 'x', currentX);
  applyImagePosition(imgEl, 'y', currentY);
  applyImagePosition(imgEl, 'scale', currentScale);
}
```

### Bug 2: Card Grid Reference区块显示异常 / 样式缺失

**文件**: `css/styles.css`, `docs/css/styles.css`

**根因**: `templates.js` 中的 `renderCardReferences` 和 `formatCardGridDetail` 函数生成了以下 CSS 类的 HTML 元素，但在样式表中完全没有对应的 CSS 定义：

- `.detail-rich-text--formatted` — Card Grid详情文本容器
- `.detail-subtitle` — 子标题（如 "References"）
- `.detail-reference-block` — Reference区块容器
- `.detail-reference-list` — Reference有序列表
- `.detail-reference-item` — Reference列表项
- `.detail-reference-link` — Reference外部链接
- `.detail-table-wrap` / `.detail-table` — Markdown表格

**修复方式**: 为上述所有类添加了完整的CSS样式定义，包括：
- `detail-rich-text--formatted`: 覆盖 `white-space: pre-line` 为 `normal`，修复HTML格式化内容布局
- 表格样式: 边框、间距、hover效果
- Reference区块: 分割线、编号列表、链接颜色及hover效果

## 影响范围

- Card Grid 模板的详情面板（翻转后的背面内容）
- 所有卡片的Banner图片位置/缩放控制
- 所有卡片的内联Reference显示
- Markdown表格渲染（如能源对比表格）

## 修改文件清单

| 文件 | 修改内容 |
|------|----------|
| `js/section-renderer.js` | 添加初始位置值应用逻辑 |
| `docs/js/section-renderer.js` | 同上 |
| `css/styles.css` | 添加card-grid detail相关CSS |
| `docs/css/styles.css` | 同上 |

## 补充修复（同日）

### Bug 3: 导出到 `docs/index.html` 后 Hero Video Mode UI 丢失

**现象**:
- 在可视化编辑界面，Hero Video Mode 正常（文字淡出、退出按钮与进度条可见）
- 在 `docs/index.html` 打开时，只有视频声音，文字不隐藏，退出按钮和进度条不显示

**根因**:
Viewer 页面没有加载 `cinema-mode-overrides.css`。  
`main.js` 进入视频模式时只负责给 `section#overview` 添加 `.cinema-mode` 类；真正控制 UI 切换（隐藏文案、显示控制条和退出按钮）的样式定义在 `cinema-mode-overrides.css` 中。缺少该样式文件时，功能逻辑执行了，但视觉状态不会切换。

**修复方式**:
在以下文件 `<head>` 中补充样式引用：
- `index.html`
- `docs/index.html`

```html
<link href="./css/cinema-mode-overrides.css" rel="stylesheet">
```

### Bug 4: `保存全部` 后 Video Mode 再次失效（保存链路覆盖）

**现象**:
- 手动修好 `docs/index.html` 后，Video Mode 正常
- 执行一次“保存全部”后，导出产物中的 Video Mode 再次失效

**根因**:
保存链路会重新生成 viewer 的 `index.html`，而不是保留你手动修改的文件：
- `saveAll()` → `OfflineSiteSaver.saveCompleteOfflineSite()` → `generateViewerHtml()`
- 该生成器历史上只注入 `css/styles.css`，没有注入 `css/cinema-mode-overrides.css`

因此每次保存都会把正确的 `<link>` 覆盖掉，造成“修好后又坏”。

**修复方式**:
1. 在 `js/offline-site-saver.js` 中同时修两处：
   - `getStyleFiles()` 增加 `css/cinema-mode-overrides.css`，确保导出文件夹会写入该 CSS
   - `generateViewerHtml()` 增加 `<link href="./css/cinema-mode-overrides.css" rel="stylesheet">`
2. 在 ZIP 导出链路的 HTML 生成函数中也补齐同样的 `<link>`：
   - `js/editor.js` 的 `generateOfflineViewerHtml()`
   - `docs/js/editor.js` 的 `generateOfflineViewerHtml()`

这样无论是“保存到文件夹”还是“导出 zip”，新生成的 viewer 都会稳定包含 cinema mode 样式，不再回退。

## 增量更新（编辑器 Top Menu 跳转可见性控制）

### 功能目标

在编辑界面中，支持按 section 自定义顶部 menu bar 的跳转项是否显示，而不影响 section 本体是否渲染。

### 实现方式

1. **新增配置字段（向后兼容）**
   - 在 section 配置上增加 `showInNav` 字段。
   - 默认规则：`showInNav !== false` 即显示，兼容历史数据（历史数据未配置该字段时继续显示）。

2. **顶部导航渲染过滤**
   - 修改 `updateNavLinks()` 的筛选逻辑为：
     - `enabled === true` 且 `showInNav !== false` 才加入顶部跳转列表。
   - 修改文件：
     - `js/section-renderer.js`
     - `docs/js/section-renderer.js`

3. **编辑侧栏新增可视化开关**
   - 在每个 section 卡片中新增 `Menu` 开关（mini toggle）。
   - 点击后即时写入 `material.config.sections[].showInNav`，并刷新导航与侧栏状态。
   - 修改文件：
     - `js/editor.js`
     - `docs/js/editor.js`

4. **新增样式**
   - 为侧栏 `Menu` 开关增加样式类：
     - `.sidebar-section-nav-toggle`
     - `.sidebar-mini-toggle`
     - `.sidebar-mini-toggle-knob`
   - 修改文件：
     - `css/input.css`
     - `css/styles.css`
     - `docs/css/styles.css`

5. **新建 section 默认行为**
   - `addSection()` 新增默认值 `showInNav: true`，保证新建 section 默认出现在顶部 menu。

### 说明

- 该功能与 `enabled` 分离：  
  - `enabled` 控制 section 是否渲染到页面；  
  - `showInNav` 控制是否出现在顶部 menu 跳转。

### 后续修正（同日）

- **问题现象**：关闭 `Menu` 开关后，顶部导航仍显示该项，但对应 section 内容反而被隐藏。  
- **根因**：`showInNav` 过滤错误地加在了主渲染流程 `render()` 的 section 列表上，而不是导航更新函数 `updateNavLinks()`。  
- **修复**：
  - `render()` 恢复为仅按 `enabled` 过滤；
  - `updateNavLinks()` 改为按 `enabled && showInNav !== false` 过滤。
- **修复文件**：
  - `js/section-renderer.js`
  - `docs/js/section-renderer.js`

---

## v0.9.2 Interactive Details 过渡动画优化

### 变更内容

**问题背景**：Interactive Details 模板的右侧面板切换使用了 `flip-y` 旋转动画方案，该方案依赖 `animationend` 事件 + 自定义 CSS keyframes，但对应的 keyframes 实际上从未被定义，导致 `isAnimating` 永远不会复位，后续点击失效。

**优化目标**：改为简洁流畅的苹果风格渐变（cross-fade）切换。

### 实现方式

#### 1. `css/input.css` — 新增面板与列表展开 CSS

**右侧面板（cross-fade）**：
```css
.id-detail-panel {
  position: absolute; inset: 0;
  opacity: 0; pointer-events: none;
  transform: scale(0.97);
  transition: opacity 0.38s, transform 0.38s;  /* Apple ease-out curve */
}
.id-detail-panel--active {
  opacity: 1; pointer-events: auto;
  transform: scale(1);
}
```

**左侧描述展开（max-height 平滑）**：
```css
.id-item-desc {
  max-height: 0; overflow: hidden; opacity: 0;
  transition: max-height 0.42s, opacity 0.28s;
}
.id-item-desc--open {
  max-height: 320px; opacity: 1;
}
```

#### 2. `js/section-renderer.js` — 简化动画逻辑

移除了：
- `data-animation` 属性判断分支
- `cube-y`/`cube-x` 旋转分支
- `flip-out`/`flip-in` 的 animationend 事件链

替换为：
```javascript
// 直接切换 active class，CSS transition 自动完成 cross-fade
currentPanel.classList.remove('id-detail-panel--active');
targetPanel.classList.add('id-detail-panel--active');
currentIndex = targetIndex;
setTimeout(() => { isAnimating = false; }, 400);
```

#### 3. `js/templates.js` — 移除 `data-animation` 和 flipper 包装层

- 删除 `data-animation="flip-y"` 属性
- 删除多余的 `.id-detail-flipper` 包装 div（面板直接位于容器内）
- 删除 `id-item-desc` 上的 Tailwind `transition-all duration-500` 类（已由 CSS 接管）

#### 修改文件
- `css/input.css`
- `css/styles.css`（rebuild）
- `docs/css/styles.css`（sync）
- `js/section-renderer.js`
- `js/templates.js`
- `docs/js/section-renderer.js`
- `docs/js/templates.js`

---

## v0.9.3 Interactive Details 标题区居中 + subheadline 简介

### 变更内容

参照 Gridcard (card-grid) 的排版，在 Interactive Details 模板的标题区域新增简介（subheadline）支持，并将标题与简介改为居中对齐。

**改动点：**

- **`js/templates.js` / `docs/js/templates.js`**：
  - 标题（headline）改为 `text-center` 居中
  - 在 headline 下方新增 subheadline，当 `data.subheadline` 非空时渲染：
    - 字号 `21px`，颜色 `text-white/50`，`max-w-[720px] mx-auto`
  - 两者包裹在一个 `text-center mb-[80px] fade-in-up` 容器中，任意一个存在即渲染该容器
  - `data-material` 绑定为 `${sectionId}.subheadline`，支持 CMS 编辑

- **`docs/material.json`**：
  - 在 `index.Fusion2` 下紧跟 `headline` 后新增 `"subheadline": ""`（留空，便于 CMS 编辑填写）

### 字段说明

| 字段 | 位置 | 说明 |
|------|------|------|
| `headline` | `{sectionId}.headline` | 大标题，64px |
| `subheadline` | `{sectionId}.subheadline` | 简介，21px，留空则不渲染 |
